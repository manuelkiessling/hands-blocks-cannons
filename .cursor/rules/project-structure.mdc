---
description: Monorepo project structure and organization
globs: ["**/*.ts", "**/*.tsx", "**/package.json"]
---

# Project Structure

This is an **npm workspaces monorepo** with a framework, apps, and a lobby.

## Node.js Version

This project requires **Node.js 24+**. Use your preferred version manager:

**Using mise (recommended):**
```bash
mise install        # Install Node version from .tool-versions
mise use            # Activate it
```

**Using nvm:**
```bash
nvm install 24      # If not already installed
nvm use             # Activate from .nvmrc
```

Both `.nvmrc` and `.tool-versions` files are provided for compatibility.

```
cam-gesture-experiment/
├── .nvmrc            # Node version (nvm)
├── .tool-versions    # Node version (mise)
├── packages/
│   ├── framework/
│   │   ├── protocol  # @gesture-app/framework-protocol (schemas/types)
│   │   ├── server    # @gesture-app/framework-server (SessionRuntime, createAppServer)
│   │   ├── client    # @gesture-app/framework-client (SessionClient + config)
│   │   ├── input     # @gesture-app/framework-input (HandTracker, gestures)
│   │   └── build     # @gesture-app/framework-build (Vite config, build utils)
│   ├── applications/
│   │   ├── blocks-cannons  # Game app (server/client/bot)
│   │   └── hello-hands     # Demo app
│   └── lobby        # Lobby service (app-agnostic, session creation, docker spawning)
└── package.json      # Workspace root
```

## Lobby Architecture

The lobby is **app-agnostic** and dynamically discovers registered applications:

- Apps self-register with `globalRegistry` when imported (via their `src/index.ts`)
- The lobby imports all apps in `packages/lobby/src/index.ts` to trigger registration
- The frontend fetches available apps from `/api/sessions/apps` and renders them dynamically
- Adding a new app requires only: (1) import in lobby's index.ts, (2) dependency in lobby's package.json
- No lobby frontend code changes are needed when adding new applications

## Package Dependencies

```mermaid
graph TD
    Protocol["@gesture-app/framework-protocol"]
    Server["@gesture-app/framework-server"]
    Client["@gesture-app/framework-client"]
    Input["@gesture-app/framework-input"]
    Build["@gesture-app/framework-build"]
    App1["@gesture-app/blocks-cannons"]
    App2["@gesture-app/hello-hands"]
    Lobby["@gesture-app/lobby"]

    Server --> Protocol
    Client --> Protocol
    App1 --> Protocol
    App1 --> Input
    App2 --> Protocol
    App2 --> Input
    Lobby --> Protocol
```

## Key Commands

Run from workspace root (after `nvm use`):

```bash
# Full validation (build + typecheck + test)
npm run validate

# Development (per workspace)
npm run dev:server -w @gesture-app/blocks-cannons
npm run dev:client -w @gesture-app/blocks-cannons
npm run dev -w @gesture-app/lobby
```

## Adding Dependencies

Always specify the workspace when adding dependencies:

```bash
# Add to specific package
npm install <package> -w @gesture-app/framework-server
npm install <package> -w @gesture-app/framework-client
npm install <package> -w @gesture-app/framework-protocol
npm install <package> -w @gesture-app/blocks-cannons
npm install <package> -w @gesture-app/hello-hands
npm install <package> -w @gesture-app/lobby

# Add dev dependency
npm install -D <package> -w @gesture-app/framework-protocol
```

## Cross-Package Imports

Import across packages using workspace package names (no relative paths):
```typescript
import { createSessionServerMessageSchema } from '@gesture-app/framework-protocol';
import { SessionRuntime, createAppServer } from '@gesture-app/framework-server';
import { SessionClient } from '@gesture-app/framework-client';
import { HandTracker, isPinching, isHandRaised } from '@gesture-app/framework-input';
import { createGestureAppViteConfig } from '@gesture-app/framework-build';
import { BlocksWelcomeData } from '@gesture-app/blocks-cannons';
```

## Build Order

When building the full project:

1. `@gesture-app/framework-protocol` must build first
2. `@gesture-app/framework-server`, `@gesture-app/framework-client`, `@gesture-app/framework-input` can build afterward
3. `@gesture-app/framework-build`, `@gesture-app/framework-testing` (depend on protocol)
4. Applications can build last (depend on framework packages)

The root `validate` script handles this automatically.

## Troubleshooting

If you encounter Node.js errors or missing features:

```bash
# Verify you're using the correct Node version
node --version   # Should show v24.x.x

# If not, activate the correct version
nvm use
```
