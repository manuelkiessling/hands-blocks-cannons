# Docker Compose for Gesture Apps Multi-App Lobby
#
# This file is for PRODUCTION deployment on the Ubuntu server.
# The lobby container is started here; game session containers are spawned dynamically.
#
# Prerequisites:
# - Traefik reverse proxy running with 'outermost_router' network
# - TLS certificates configured in Traefik
# - DNS: *.dx-tooling.org -> server IP
#
# Deployment:
#   docker build -t blocks-cannons-game-session -f packages/applications/blocks-cannons/docker/Dockerfile .
#   docker compose up --build -d

services:
  lobby:
    build:
      context: .
      dockerfile: docker/lobby/Dockerfile
    container_name: gestures-lobby
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "outermost_router.enable=true"
      - "traefik.docker.network=outermost_router"
      - "traefik.http.routers.gestures-lobby.rule=Host(`gestures-apps.dx-tooling.org`)"
      - "traefik.http.routers.gestures-lobby.entrypoints=websecure"
      - "traefik.http.routers.gestures-lobby.tls=true"
      - "traefik.http.services.gestures-lobby.loadbalancer.server.port=80"
    volumes:
      # Mount the docker-cli-wrapper script (read-only)
      - ./bin/docker-cli-wrapper.sh:/app/bin/docker-cli-wrapper.sh:ro
      # Mount Docker socket to allow container to control host Docker daemon
      # Note: Write access is needed to create/stop/remove containers
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - outermost_router
    environment:
      - NODE_ENV=production
      - PORT=80
      - DOCKER_WRAPPER_PATH=/app/bin/docker-cli-wrapper.sh
    # Run as root to access Docker socket (the wrapper script provides security)
    # Alternatively, you could create a docker group and add a user, but root is simpler
    # and the wrapper script restricts what Docker commands can be executed

networks:
  outermost_router:
    external: true

